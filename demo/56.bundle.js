"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[56],{56:(e,t,i)=>{i.r(t),i.d(t,{clone:()=>s,retarget:()=>o,retargetClip:()=>r});var n=i(173);function o(e,t,i={}){const o=new n.Vector3,r=new n.Quaternion,s=new n.Vector3,l=new n.Matrix4,u=new n.Matrix4,c=new n.Matrix4;i.preserveMatrix=void 0===i.preserveMatrix||i.preserveMatrix,i.preservePosition=void 0===i.preservePosition||i.preservePosition,i.preserveHipPosition=void 0!==i.preserveHipPosition&&i.preserveHipPosition,i.useTargetMatrix=void 0!==i.useTargetMatrix&&i.useTargetMatrix,i.hip=void 0!==i.hip?i.hip:"hip",i.names=i.names||{};const m=t.isObject3D?t.skeleton.bones:p(t),d=e.isObject3D?e.skeleton.bones:p(e);let f,x,v,M,h;if(e.isObject3D?e.skeleton.pose():(i.useTargetMatrix=!0,i.preserveMatrix=!1),i.preservePosition){h=[];for(let e=0;e<d.length;e++)h.push(d[e].position.clone())}if(i.preserveMatrix){e.updateMatrixWorld(),e.matrixWorld.identity();for(let t=0;t<e.children.length;++t)e.children[t].updateMatrixWorld(!0)}if(i.offsets){f=[];for(let e=0;e<d.length;++e)x=d[e],v=i.names[x.name]||x.name,i.offsets[v]&&(x.matrix.multiply(i.offsets[v]),x.matrix.decompose(x.position,x.quaternion,x.scale),x.updateMatrixWorld()),f.push(x.matrixWorld.clone())}for(let t=0;t<d.length;++t){if(x=d[t],v=i.names[x.name]||x.name,M=a(v,m),c.copy(x.matrixWorld),M){if(M.updateMatrixWorld(),i.useTargetMatrix?u.copy(M.matrixWorld):(u.copy(e.matrixWorld).invert(),u.multiply(M.matrixWorld)),s.setFromMatrixScale(u),u.scale(s.set(1/s.x,1/s.y,1/s.z)),c.makeRotationFromQuaternion(r.setFromRotationMatrix(u)),e.isObject3D){const t=d.indexOf(x),i=f?f[t]:l.copy(e.skeleton.boneInverses[t]).invert();c.multiply(i)}c.copyPosition(u)}x.parent&&x.parent.isBone?(x.matrix.copy(x.parent.matrixWorld).invert(),x.matrix.multiply(c)):x.matrix.copy(c),i.preserveHipPosition&&v===i.hip&&x.matrix.setPosition(o.set(0,x.position.y,0)),x.matrix.decompose(x.position,x.quaternion,x.scale),x.updateMatrixWorld()}if(i.preservePosition)for(let e=0;e<d.length;++e)x=d[e],v=i.names[x.name]||x.name,v!==i.hip&&x.position.copy(h[e]);i.preserveMatrix&&e.updateMatrixWorld(!0)}function r(e,t,i,r={}){r.useFirstFramePosition=void 0!==r.useFirstFramePosition&&r.useFirstFramePosition,r.fps=void 0!==r.fps?r.fps:30,r.names=r.names||[],t.isObject3D||(t=function(e){const t=new n.SkeletonHelper(e.bones[0]);return t.skeleton=e,t}(t));const s=Math.round(i.duration*(r.fps/1e3)*1e3),l=1/r.fps,u=[],c=new n.AnimationMixer(t),m=p(e.skeleton),d=[];let f,x,v,M,h;c.clipAction(i).play(),c.update(0),t.updateMatrixWorld();for(let i=0;i<s;++i){const n=i*l;o(e,t,r);for(let e=0;e<m.length;++e)h=r.names[m[e].name]||m[e].name,v=a(h,t.skeleton),v&&(x=m[e],M=d[e]=d[e]||{bone:x},r.hip===h&&(M.pos||(M.pos={times:new Float32Array(s),values:new Float32Array(3*s)}),r.useFirstFramePosition&&(0===i&&(f=x.position.clone()),x.position.sub(f)),M.pos.times[i]=n,x.position.toArray(M.pos.values,3*i)),M.quat||(M.quat={times:new Float32Array(s),values:new Float32Array(4*s)}),M.quat.times[i]=n,x.quaternion.toArray(M.quat.values,4*i));c.update(l),t.updateMatrixWorld()}for(let e=0;e<d.length;++e)M=d[e],M&&(M.pos&&u.push(new n.VectorKeyframeTrack(".bones["+M.bone.name+"].position",M.pos.times,M.pos.values)),u.push(new n.QuaternionKeyframeTrack(".bones["+M.bone.name+"].quaternion",M.quat.times,M.quat.values)));return c.uncacheAction(i),new n.AnimationClip(i.name,-1,u)}function s(e){const t=new Map,i=new Map,n=e.clone();return l(e,n,(function(e,n){t.set(n,e),i.set(e,n)})),n.traverse((function(e){if(!e.isSkinnedMesh)return;const n=e,o=t.get(e),r=o.skeleton.bones;n.skeleton=o.skeleton.clone(),n.bindMatrix.copy(o.bindMatrix),n.skeleton.bones=r.map((function(e){return i.get(e)})),n.bind(n.skeleton,n.bindMatrix)})),n}function a(e,t){for(let i=0,n=p(t);i<n.length;i++)if(e===n[i].name)return n[i]}function p(e){return Array.isArray(e)?e:e.bones}function l(e,t,i){i(e,t);for(let n=0;n<e.children.length;n++)l(e.children[n],t.children[n],i)}}}]);